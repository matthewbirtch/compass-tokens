name: Sync Tokens from Figma

on:
  repository_dispatch:
    types: [figma-sync]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-tokens:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Update token files
        run: |
          # Parse the files payload and update each file
          FILES='${{ toJson(github.event.client_payload.files) }}'
          echo "Received files payload"
          
          # Extract and update each file - use jq with 2-space indentation to preserve key order
          echo "$FILES" | jq -r 'to_entries | .[] | @json' | while read -r entry; do
            filepath=$(echo "$entry" | jq -r '.key')
            content=$(echo "$entry" | jq '.value')
            echo "Updating $filepath"
            echo "$content" | jq --indent 2 '.' > "$filepath"
          done
      
      - name: Validate tokens
        run: node scripts/validate-tokens.js
      
      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet tokens/src/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected - tokens are already in sync"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected - will create PR"
            echo "Changed files:"
            git diff --name-only tokens/src/
          fi
      
      - name: Get changed files list
        if: steps.check_changes.outputs.has_changes == 'true'
        id: changed_files
        run: |
          CHANGED=$(git diff --name-only tokens/src/ | tr '\n' ', ' | sed 's/,$//')
          echo "files=$CHANGED" >> $GITHUB_OUTPUT
      
      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: sync tokens from Figma"
          branch: figma-sync/${{ github.run_number }}
          title: "chore: sync tokens from Figma"
          body: |
            ## ðŸŽ¨ Sync Design Tokens from Figma
            
            This PR updates design tokens synced from Figma via the Compass Token Sync plugin.
            
            **Synced at**: ${{ github.event.client_payload.timestamp }}
            **Source**: ${{ github.event.client_payload.source }}
            
            ### Files Changed
            ${{ steps.changed_files.outputs.files }}
            
            ### What Changed
            Review the diffs to see updated token values:
            - Foundation colors: Raw HEX color values
            - Semantic tokens: References to foundation colors
            
            ---
            *Auto-generated via Figma plugin*

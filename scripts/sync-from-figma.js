#!/usr/bin/env node
/**
 * Sync Foundation Colors from Figma
 * 
 * This script fetches color variables from Figma, transforms them to DTCG format,
 * validates the output, and creates a pull request with the changes.
 * 
 * Usage: npm run sync:figma
 */

require('dotenv').config();
const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');
const { fetchVariables, extractFoundationColors } = require('./utils/figma-api');
const { buildTokenStructure, countColors, getSummary } = require('./utils/transform');
const { validateTokens, printResults } = require('./validate-tokens');

// Configuration
const CONFIG = {
  figmaToken: process.env.FIGMA_API_TOKEN,
  figmaFileId: process.env.FIGMA_FILE_ID,
  collectionName: process.env.FIGMA_COLLECTION_NAME || null,
  colorJsonPath: path.join(__dirname, '../tokens/src/foundation/color.json'),
  createPR: process.env.CREATE_PR !== 'false', // Default to true
};

/**
 * Check if required environment variables are set
 */
function checkEnvironment() {
  const errors = [];

  if (!CONFIG.figmaToken) {
    errors.push('FIGMA_API_TOKEN is not set');
  }

  if (!CONFIG.figmaFileId) {
    errors.push('FIGMA_FILE_ID is not set');
  }

  if (errors.length > 0) {
    console.error('\n‚ùå Environment Configuration Error:\n');
    errors.forEach(error => console.error(`  ‚Ä¢ ${error}`));
    console.error('\nPlease create a .env file based on .env.example and fill in the required values.\n');
    process.exit(1);
  }
}

/**
 * Check if GitHub CLI is installed and authenticated
 */
function checkGitHubCLI() {
  try {
    execSync('gh --version', { stdio: 'pipe' });
    execSync('gh auth status', { stdio: 'pipe' });
    return true;
  } catch (error) {
    console.warn('\n‚ö†Ô∏è  GitHub CLI (gh) not found or not authenticated.');
    console.warn('   PR creation will be skipped. You can commit manually.\n');
    console.warn('   To install: brew install gh');
    console.warn('   To authenticate: gh auth login\n');
    return false;
  }
}

/**
 * Check if there are uncommitted changes
 */
function hasUncommittedChanges() {
  try {
    const status = execSync('git status --porcelain', { encoding: 'utf8' });
    return status.trim().length > 0;
  } catch (error) {
    return false;
  }
}

/**
 * Create a git branch for the sync
 */
function createBranch() {
  const timestamp = new Date().toISOString().split('T')[0].replace(/-/g, '');
  const branchName = `figma-sync-${timestamp}`;
  
  try {
    // Ensure we're on main/master
    const currentBranch = execSync('git branch --show-current', { encoding: 'utf8' }).trim();
    
    if (currentBranch !== 'main' && currentBranch !== 'master') {
      console.warn(`‚ö†Ô∏è  Currently on branch "${currentBranch}", not main/master`);
    }

    // Create and checkout new branch
    execSync(`git checkout -b ${branchName}`, { stdio: 'pipe' });
    console.log(`‚úì Created branch: ${branchName}`);
    return branchName;
  } catch (error) {
    throw new Error(`Failed to create branch: ${error.message}`);
  }
}

/**
 * Commit and push changes
 */
function commitAndPush(branchName, colorCount, summary) {
  try {
    // Stage the color.json file
    execSync(`git add ${CONFIG.colorJsonPath}`, { stdio: 'pipe' });

    // Create commit message
    const summaryText = Object.entries(summary)
      .map(([family, count]) => `${family}: ${count}`)
      .join(', ');

    const commitMessage = `chore: sync foundation colors from Figma

Updated ${colorCount} foundation color tokens from Figma.

Color families: ${summaryText}

Synced at: ${new Date().toISOString()}`;

    // Commit
    execSync(`git commit -m "${commitMessage}"`, { stdio: 'pipe' });
    console.log('‚úì Created commit');

    // Push
    execSync(`git push -u origin ${branchName}`, { stdio: 'pipe' });
    console.log('‚úì Pushed to remote');

    return true;
  } catch (error) {
    console.error(`‚ùå Git operation failed: ${error.message}`);
    return false;
  }
}

/**
 * Create a pull request using GitHub CLI
 */
function createPullRequest(colorCount, summary) {
  try {
    const summaryText = Object.entries(summary)
      .map(([family, count]) => `- **${family}**: ${count} shades`)
      .join('\n');

    const prBody = `## üé® Sync Foundation Colors from Figma

This PR updates foundation color tokens synced from Figma.

### Summary
- **Total colors**: ${colorCount}
- **Synced at**: ${new Date().toISOString()}

### Color Families
${summaryText}

### What Changed
Review the diff in \`tokens/src/foundation/color.json\` to see updated color values.

---
*Auto-generated by \`npm run sync:figma\`*`;

    const result = execSync(
      `gh pr create --title "chore: sync foundation colors from Figma" --body "${prBody.replace(/"/g, '\\"')}"`,
      { encoding: 'utf8' }
    );

    const prUrl = result.trim().split('\n').pop();
    console.log('\n‚úì Created Pull Request:');
    console.log(`  ${prUrl}\n`);

    return prUrl;
  } catch (error) {
    console.error(`‚ùå Failed to create PR: ${error.message}`);
    return null;
  }
}

/**
 * Main sync function
 */
async function sync() {
  console.log('\n' + '='.repeat(60));
  console.log('FIGMA TOKEN SYNC');
  console.log('='.repeat(60) + '\n');

  // Step 1: Check environment
  console.log('1Ô∏è‚É£  Checking environment...');
  checkEnvironment();
  console.log('   ‚úì Environment configured\n');

  // Step 2: Check GitHub CLI
  console.log('2Ô∏è‚É£  Checking GitHub CLI...');
  const hasGH = checkGitHubCLI();
  
  // Step 3: Fetch from Figma
  console.log('3Ô∏è‚É£  Fetching variables from Figma...');
  console.log(`   File ID: ${CONFIG.figmaFileId}`);
  
  const data = await fetchVariables(CONFIG.figmaFileId, CONFIG.figmaToken);
  console.log('   ‚úì Successfully fetched data from Figma\n');

  // Step 4: Extract foundation colors
  console.log('4Ô∏è‚É£  Extracting foundation colors...');
  const variables = extractFoundationColors(data, CONFIG.collectionName);
  console.log(`   ‚úì Found ${variables.length} foundation color variables\n`);

  if (variables.length === 0) {
    console.error('‚ùå No foundation colors found. Check your Figma file.');
    process.exit(1);
  }

  // Step 5: Transform to DTCG format
  console.log('5Ô∏è‚É£  Transforming to DTCG format...');
  const tokens = buildTokenStructure(variables);
  const colorCount = countColors(tokens);
  const summary = getSummary(tokens);
  
  console.log('\n   Color Summary:');
  Object.entries(summary).forEach(([family, count]) => {
    console.log(`     ‚Ä¢ ${family}: ${count} shades`);
  });
  console.log();

  // Step 6: Validate tokens
  console.log('6Ô∏è‚É£  Validating tokens...');
  const validation = validateTokens(tokens);
  
  if (!validation.valid) {
    console.error('‚ùå Validation failed:\n');
    validation.errors.forEach(error => console.error(`  ‚Ä¢ ${error}`));
    process.exit(1);
  }
  
  if (validation.warnings.length > 0) {
    console.warn('‚ö†Ô∏è  Validation warnings:\n');
    validation.warnings.forEach(warning => console.warn(`  ‚Ä¢ ${warning}`));
    console.log();
  } else {
    console.log('   ‚úì Validation passed\n');
  }

  // Step 7: Write to file
  console.log('7Ô∏è‚É£  Writing to color.json...');
  const jsonContent = JSON.stringify(tokens, null, 2) + '\n';
  fs.writeFileSync(CONFIG.colorJsonPath, jsonContent, 'utf8');
  console.log(`   ‚úì Updated ${CONFIG.colorJsonPath}\n`);

  // Step 8: Check for changes
  console.log('8Ô∏è‚É£  Checking for changes...');
  if (!hasUncommittedChanges()) {
    console.log('   ‚ÑπÔ∏è  No changes detected. Colors are already in sync.\n');
    return;
  }
  console.log('   ‚úì Changes detected\n');

  // Step 9: Create branch and commit
  if (hasGH && CONFIG.createPR) {
    console.log('9Ô∏è‚É£  Creating branch and committing...');
    const branchName = createBranch();
    
    if (commitAndPush(branchName, colorCount, summary)) {
      // Step 10: Create PR
      console.log('\nüîü Creating pull request...');
      createPullRequest(colorCount, summary);
    }
  } else {
    console.log('\n9Ô∏è‚É£  Changes ready to commit:');
    console.log('   Run the following commands to commit manually:\n');
    console.log(`     git add ${CONFIG.colorJsonPath}`);
    console.log('     git commit -m "chore: sync foundation colors from Figma"');
    console.log('     git push\n');
  }

  console.log('='.repeat(60));
  console.log('‚úÖ SYNC COMPLETE');
  console.log('='.repeat(60) + '\n');
}

// Run the sync
sync().catch(error => {
  console.error('\n‚ùå Sync failed:', error.message);
  console.error(error.stack);
  process.exit(1);
});

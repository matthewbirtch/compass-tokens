<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Compass Token Sync</title>
  <link rel="stylesheet" href="ui.css">
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>üé® Compass Token Sync</h1>
      <p class="subtitle">Sync design tokens to GitHub</p>
    </div>

    <!-- Status Section -->
    <div id="status-section" class="section">
      <div class="status-card">
        <div class="status-indicator" id="status-indicator">
          <span id="status-icon">‚ö™</span>
          <span id="status-text">Loading...</span>
        </div>
        <div class="last-sync" id="last-sync">
          Last sync: Never
        </div>
      </div>
    </div>

    <!-- Main Action -->
    <div class="section">
      <button id="sync-button" class="primary-button" disabled>
        <span id="sync-button-text">Sync to GitHub</span>
      </button>
      
      <button id="save-local-button" class="secondary-button">
        üíæ Save JSON Locally
      </button>
    </div>

    <!-- Progress/Results -->
    <div id="progress-section" class="section" style="display: none;">
      <div class="progress-card">
        <div id="progress-message">Processing...</div>
        <div id="progress-details"></div>
        <div id="files-list" style="margin-top: 8px; font-size: 11px; color: #666;"></div>
      </div>
    </div>

    <!-- Settings -->
    <details class="section">
      <summary>‚öôÔ∏è Settings</summary>
      <div class="settings-content">
        <label for="github-token">GitHub Personal Access Token</label>
        <input 
          type="password" 
          id="github-token" 
          placeholder="ghp_..." 
          autocomplete="off"
        />
        <div class="button-group">
          <button id="save-token-button" class="small-button">Save Token</button>
          <button id="clear-token-button" class="small-button danger">Clear Token</button>
        </div>
        <p class="help-text">
          Token is stored securely in Figma and never leaves your computer.
          <br><br>
          <strong>Required scope:</strong> <code>repo</code> (full repository access)
          <br><br>
          Create at: <a href="https://github.com/settings/tokens" target="_blank">github.com/settings/tokens</a>
        </p>
      </div>
    </details>

    <!-- Info -->
    <details class="section">
      <summary>‚ÑπÔ∏è What Gets Synced</summary>
      <div class="info-content">
        <p><strong>Foundation Colors:</strong></p>
        <ul>
          <li>‚úÖ Pattern: <code>blue/500</code>, <code>neutral/1000</code></li>
          <li>‚úÖ 10 color families √ó 8-25 shades</li>
          <li>‚úÖ Output: HEX values (#1C58D9)</li>
        </ul>
        
        <p><strong>Semantic Attachment Colors:</strong></p>
        <ul>
          <li>‚úÖ Pattern: <code>attachment/blue</code>, <code>attachment/grey</code></li>
          <li>‚úÖ 5 colors (blue, green, orange, red, grey)</li>
          <li>‚úÖ Output: Foundation references ({color.foundation.blue.300})</li>
        </ul>
        
        <p><strong>Theme Colors:</strong></p>
        <ul>
          <li>‚úÖ Extracts from Variable Modes (Denim, Sapphire, Quartz, Onyx, Indigo)</li>
          <li>‚úÖ All theme variables (sidebar-bg, button-bg, etc.)</li>
          <li>‚úÖ Output: HEX values or foundation references</li>
          <li>‚úÖ Each mode creates separate theme file (denim.json, sapphire.json, etc.)</li>
        </ul>
        
        <p><strong>Foundation Typography:</strong></p>
        <ul>
          <li>‚úÖ Pattern: <code>font/family/heading</code>, <code>font/size/200</code>, <code>font/weight/bold</code></li>
          <li>‚úÖ Line heights: <code>line-height/heading/1000</code>, <code>line-height/body/200</code></li>
          <li>‚úÖ Letter spacing: <code>letter-spacing/tight-1</code>, <code>letter-spacing/normal</code></li>
          <li>‚úÖ Output: Font families as arrays, dimensions as numbers</li>
        </ul>
        
        <p><strong>Semantic Typography:</strong></p>
        <ul>
          <li>‚úÖ Extracted from Figma Text Styles</li>
          <li>‚úÖ Pattern: <code>heading/1000</code>, <code>body/300-semibold</code></li>
          <li>‚úÖ Output: Composite tokens referencing foundation values</li>
        </ul>
      </div>
    </details>
  </div>

  <script>
    let hasToken = false;
    let lastSync = null;

    // Update status display
    function updateStatus(tokenExists, syncTime) {
      hasToken = tokenExists;  // Update the outer variable
      lastSync = syncTime;
      
      const indicator = document.getElementById('status-indicator');
      const icon = document.getElementById('status-icon');
      const text = document.getElementById('status-text');
      const syncButton = document.getElementById('sync-button');
      const lastSyncEl = document.getElementById('last-sync');
      const tokenInput = document.getElementById('github-token');
      
      if (tokenExists) {
        icon.textContent = '‚úÖ';
        text.textContent = 'Ready to sync';
        syncButton.disabled = false;
        // Show placeholder indicating token is saved
        tokenInput.placeholder = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢ (saved)';
      } else {
        icon.textContent = '‚ö†Ô∏è';
        text.textContent = 'Configure token in Settings';
        syncButton.disabled = true;
        tokenInput.placeholder = 'ghp_...';
      }
      
      if (syncTime) {
        const date = new Date(syncTime);
        lastSyncEl.textContent = `Last sync: ${date.toLocaleString()}`;
      } else {
        lastSyncEl.textContent = 'Last sync: Never';
      }
    }

    // Show progress
    function showProgress(message, details = '', files = []) {
      const section = document.getElementById('progress-section');
      const messageEl = document.getElementById('progress-message');
      const detailsEl = document.getElementById('progress-details');
      const filesEl = document.getElementById('files-list');
      
      section.style.display = 'block';
      messageEl.textContent = message;
      detailsEl.textContent = details;
      
      if (files && files.length > 0) {
        filesEl.innerHTML = '<strong>Files:</strong><br>' + 
          files.map(f => '‚Ä¢ ' + f.split('/').pop()).join('<br>');
        filesEl.style.display = 'block';
      } else {
        filesEl.style.display = 'none';
      }
    }

    // Hide progress
    function hideProgress() {
      document.getElementById('progress-section').style.display = 'none';
    }

    // Show error
    function showError(message) {
      showProgress('‚ùå Error', message);
      setTimeout(hideProgress, 5000);
    }

    // Show success
    function showSuccess(message, files = []) {
      showProgress('‚úÖ Success!', message, files);
      setTimeout(hideProgress, 5000);
    }

    // Handle sync to GitHub
    document.getElementById('sync-button').onclick = () => {
      console.log('Sync button clicked');
      console.log('Has token:', hasToken);
      
      if (!hasToken) {
        showError('Please configure GitHub token in Settings first');
        return;
      }
      
      showProgress('Syncing to GitHub...', 'Extracting colors from Figma...');
      console.log('Sending sync message to plugin');
      parent.postMessage({ pluginMessage: { type: 'sync-to-github' } }, '*');
    };

    // Handle save locally
    document.getElementById('save-local-button').onclick = () => {
      showProgress('Exporting colors...', 'Extracting colors from Figma...');
      parent.postMessage({ pluginMessage: { type: 'save-locally' } }, '*');
    };

    // Handle save token
    document.getElementById('save-token-button').onclick = () => {
      const token = document.getElementById('github-token').value.trim();
      if (!token) {
        showError('Please enter a token');
        return;
      }
      
      showProgress('Saving token...', '');
      parent.postMessage({ 
        pluginMessage: { 
          type: 'save-github-token',
          token: token
        } 
      }, '*');
    };

    // Handle clear token
    document.getElementById('clear-token-button').onclick = () => {
      if (confirm('Are you sure you want to clear the saved token?')) {
        document.getElementById('github-token').value = '';
        parent.postMessage({ pluginMessage: { type: 'clear-github-token' } }, '*');
      }
    };

    // Handle messages from plugin
    onmessage = (event) => {
      const msg = event.data.pluginMessage;
      
      switch (msg.type) {
        case 'init':
        case 'status':
          updateStatus(msg.data.hasToken, msg.data.lastSync);
          hideProgress();
          break;
        
        case 'sync-started':
          showProgress('Syncing...', 'Extracting colors from Figma...');
          break;
        
        case 'extracted':
          const totalTokens = msg.data.total.processed;
          const foundationCount = msg.data.foundationColors.processed;
          const semanticCount = msg.data.semanticAttachment.processed;
          const radiusCount = msg.data.foundationRadius ? msg.data.foundationRadius.processed : 0;
          const spacingCount = msg.data.foundationSpacing ? msg.data.foundationSpacing.processed : 0;
          const typographyCount = msg.data.foundationTypography ? msg.data.foundationTypography.processed : 0;
          const semanticTypographyCount = msg.data.semanticTypography ? msg.data.semanticTypography.processed : 0;
          const themeCount = msg.data.themes && msg.data.themes.processed ? msg.data.themes.processed : 0;
          const themeModesCount = msg.data.themes && msg.data.themes.modes ? msg.data.themes.modes : 0;
          
          let detailParts = [];
          if (foundationCount > 0) detailParts.push(`Colors: ${foundationCount}`);
          if (semanticCount > 0) detailParts.push(`Attachment: ${semanticCount}`);
          if (radiusCount > 0) detailParts.push(`Radius: ${radiusCount}`);
          if (spacingCount > 0) detailParts.push(`Spacing: ${spacingCount}`);
          if (typographyCount > 0) detailParts.push(`Typography: ${typographyCount}`);
          if (semanticTypographyCount > 0) detailParts.push(`Text Styles: ${semanticTypographyCount}`);
          if (themeCount > 0) detailParts.push(`Themes: ${themeCount} tokens across ${themeModesCount} modes`);
          
          const details = detailParts.join(' | ') + ` | Total: ${totalTokens}`;
          
          showProgress('Tokens extracted!', details);
          break;
        
        case 'sync-success':
          const totalSynced = msg.data.totalTokens;
          const filesChanged = msg.data.changedFiles.length;
          
          showSuccess(
            `Successfully synced ${totalSynced} tokens!`,
            msg.data.changedFiles
          );
          updateStatus(true, msg.data.timestamp);
          break;
        
        case 'no-changes':
          showProgress(
            '‚ÑπÔ∏è No changes detected',
            `All ${msg.data.totalTokens} tokens are already in sync with the repository!`
          );
          setTimeout(hideProgress, 4000);
          break;
        
        case 'progress':
          showProgress('‚è≥ Syncing...', msg.message);
          break;
        
        case 'saved-locally':
          const savedTotal = msg.data.total.processed;
          const savedFoundation = msg.data.foundationColors.processed;
          const savedSemantic = msg.data.semanticAttachment.processed;
          
          showSuccess(
            `Exported ${savedTotal} tokens (${savedFoundation} foundation + ${savedSemantic} semantic). Check your downloads folder!`
          );
          break;
        
        case 'token-saved':
          showSuccess('GitHub token saved successfully!');
          // Clear input field after saving
          document.getElementById('github-token').value = '';
          updateStatus(true, lastSync);
          console.log('Token saved, hasToken now:', hasToken);
          break;
        
        case 'token-cleared':
          showSuccess('GitHub token cleared');
          updateStatus(false, lastSync);
          break;
        
        case 'download':
          // Create download link
          const blob = new Blob([msg.data.content], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = msg.data.filename;
          a.click();
          URL.revokeObjectURL(url);
          break;
        
        case 'error':
          showError(msg.error);
          break;
      }
    };

    // Request initial status
    parent.postMessage({ pluginMessage: { type: 'get-status' } }, '*');
  </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Compass Token Sync</title>
  <link rel="stylesheet" href="ui.css">
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>üé® Compass Token Sync</h1>
      <p class="subtitle">Sync foundation colors to GitHub</p>
    </div>

    <!-- Status Section -->
    <div id="status-section" class="section">
      <div class="status-card">
        <div class="status-indicator" id="status-indicator">
          <span id="status-icon">‚ö™</span>
          <span id="status-text">Loading...</span>
        </div>
        <div class="last-sync" id="last-sync">
          Last sync: Never
        </div>
      </div>
    </div>

    <!-- Main Action -->
    <div class="section">
      <button id="sync-button" class="primary-button" disabled>
        <span id="sync-button-text">Sync to GitHub</span>
      </button>
      
      <button id="save-local-button" class="secondary-button">
        üíæ Save JSON Locally
      </button>
    </div>

    <!-- Progress/Results -->
    <div id="progress-section" class="section" style="display: none;">
      <div class="progress-card">
        <div id="progress-message">Processing...</div>
        <div id="progress-details"></div>
      </div>
    </div>

    <!-- Settings -->
    <details class="section">
      <summary>‚öôÔ∏è Settings</summary>
      <div class="settings-content">
        <label for="github-token">GitHub Personal Access Token</label>
        <input 
          type="password" 
          id="github-token" 
          placeholder="ghp_..." 
          autocomplete="off"
        />
        <div class="button-group">
          <button id="save-token-button" class="small-button">Save Token</button>
          <button id="clear-token-button" class="small-button danger">Clear Token</button>
        </div>
        <p class="help-text">
          Token is stored securely in Figma and never leaves your computer.
          <br><br>
          <strong>Required scope:</strong> <code>repo</code> (full repository access)
          <br><br>
          Create at: <a href="https://github.com/settings/tokens" target="_blank">github.com/settings/tokens</a>
        </p>
      </div>
    </details>

    <!-- Info -->
    <details class="section">
      <summary>‚ÑπÔ∏è What Gets Synced</summary>
      <div class="info-content">
        <p><strong>Synced:</strong></p>
        <ul>
          <li>‚úÖ Foundation colors only</li>
          <li>‚úÖ Pattern: <code>blue/500</code>, <code>neutral/1000</code></li>
          <li>‚úÖ 10 color families √ó 8-25 shades</li>
        </ul>
        
        <p><strong>Not synced:</strong></p>
        <ul>
          <li>‚ùå Theme variables (Denim/Button BG)</li>
          <li>‚ùå Attachment colors (attachment-blue)</li>
          <li>‚ùå Typography variables</li>
        </ul>
      </div>
    </details>
  </div>

  <script>
    let hasToken = false;
    let lastSync = null;

    // Update status display
    function updateStatus(tokenExists, syncTime) {
      hasToken = tokenExists;  // Update the outer variable
      lastSync = syncTime;
      
      const indicator = document.getElementById('status-indicator');
      const icon = document.getElementById('status-icon');
      const text = document.getElementById('status-text');
      const syncButton = document.getElementById('sync-button');
      const lastSyncEl = document.getElementById('last-sync');
      const tokenInput = document.getElementById('github-token');
      
      if (tokenExists) {
        icon.textContent = '‚úÖ';
        text.textContent = 'Ready to sync';
        syncButton.disabled = false;
        // Show placeholder indicating token is saved
        tokenInput.placeholder = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢ (saved)';
      } else {
        icon.textContent = '‚ö†Ô∏è';
        text.textContent = 'Configure token in Settings';
        syncButton.disabled = true;
        tokenInput.placeholder = 'ghp_...';
      }
      
      if (syncTime) {
        const date = new Date(syncTime);
        lastSyncEl.textContent = `Last sync: ${date.toLocaleString()}`;
      } else {
        lastSyncEl.textContent = 'Last sync: Never';
      }
    }

    // Show progress
    function showProgress(message, details = '') {
      const section = document.getElementById('progress-section');
      const messageEl = document.getElementById('progress-message');
      const detailsEl = document.getElementById('progress-details');
      
      section.style.display = 'block';
      messageEl.textContent = message;
      detailsEl.textContent = details;
    }

    // Hide progress
    function hideProgress() {
      document.getElementById('progress-section').style.display = 'none';
    }

    // Show error
    function showError(message) {
      showProgress('‚ùå Error', message);
      setTimeout(hideProgress, 5000);
    }

    // Show success
    function showSuccess(message) {
      showProgress('‚úÖ Success!', message);
      setTimeout(hideProgress, 3000);
    }

    // Handle sync to GitHub
    document.getElementById('sync-button').onclick = () => {
      console.log('Sync button clicked');
      console.log('Has token:', hasToken);
      
      if (!hasToken) {
        showError('Please configure GitHub token in Settings first');
        return;
      }
      
      showProgress('Syncing to GitHub...', 'Extracting colors from Figma...');
      console.log('Sending sync message to plugin');
      parent.postMessage({ pluginMessage: { type: 'sync-to-github' } }, '*');
    };

    // Handle save locally
    document.getElementById('save-local-button').onclick = () => {
      showProgress('Exporting colors...', 'Extracting colors from Figma...');
      parent.postMessage({ pluginMessage: { type: 'save-locally' } }, '*');
    };

    // Handle save token
    document.getElementById('save-token-button').onclick = () => {
      const token = document.getElementById('github-token').value.trim();
      if (!token) {
        showError('Please enter a token');
        return;
      }
      
      showProgress('Saving token...', '');
      parent.postMessage({ 
        pluginMessage: { 
          type: 'save-github-token',
          token: token
        } 
      }, '*');
    };

    // Handle clear token
    document.getElementById('clear-token-button').onclick = () => {
      if (confirm('Are you sure you want to clear the saved token?')) {
        document.getElementById('github-token').value = '';
        parent.postMessage({ pluginMessage: { type: 'clear-github-token' } }, '*');
      }
    };

    // Handle messages from plugin
    onmessage = (event) => {
      const msg = event.data.pluginMessage;
      
      switch (msg.type) {
        case 'init':
        case 'status':
          updateStatus(msg.data.hasToken, msg.data.lastSync);
          hideProgress();
          break;
        
        case 'sync-started':
          showProgress('Syncing...', 'Extracting colors from Figma...');
          break;
        
        case 'extracted':
          showProgress(
            'Colors extracted!',
            `Processed ${msg.data.processed} colors from ${msg.data.families} families`
          );
          break;
        
        case 'sync-success':
          showSuccess(
            `Successfully synced ${msg.data.colorCount} colors! Pull request created on GitHub.`
          );
          updateStatus(true, msg.data.timestamp);
          break;
        
        case 'saved-locally':
          showSuccess(
            `Exported ${msg.data.processed} colors. Check your downloads folder for color.json`
          );
          break;
        
        case 'token-saved':
          showSuccess('GitHub token saved successfully!');
          // Clear input field after saving
          document.getElementById('github-token').value = '';
          updateStatus(true, lastSync);
          console.log('Token saved, hasToken now:', hasToken);
          break;
        
        case 'token-cleared':
          showSuccess('GitHub token cleared');
          updateStatus(false, lastSync);
          break;
        
        case 'download':
          // Create download link
          const blob = new Blob([msg.data.content], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = msg.data.filename;
          a.click();
          URL.revokeObjectURL(url);
          break;
        
        case 'error':
          showError(msg.error);
          break;
      }
    };

    // Request initial status
    parent.postMessage({ pluginMessage: { type: 'get-status' } }, '*');
  </script>
</body>
</html>
